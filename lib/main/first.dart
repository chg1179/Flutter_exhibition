import 'dart:async';

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:exhibition_project/main/main_add_view.dart';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

void main() {
  // Firestore Ï¥àÍ∏∞Ìôî
  final FirebaseFirestore _fs = FirebaseFirestore.instance;

  // "exhibition" Ïª¨Î†âÏÖò Í∞ÄÏ†∏Ïò§Í∏∞
  final CollectionReference collectionName = _fs.collection('exhibition');

  runApp(FirstPage());
}


class FirstPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return StreamBuilder(
      stream: FirebaseFirestore.instance.collection('exhibition').snapshots(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return CircularProgressIndicator(); // Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò¨ ÎïåÍπåÏßÄ Î°úÎî© ÌëúÏãú
        }

        final exhibitions = snapshot.data?.docs; // Ï†ÑÏãú Ï†ïÎ≥¥ Î¨∏ÏÑú Î™©Î°ù

        return Container(
          color: Colors.white, // Ï†ÑÏ≤¥ Î∞∞Í≤ΩÏÉâ
          child: ListView(
            children: [
              Container(
                color: Color(0xff464D40),// "Ïò§ÎäòÏùò Ï†ÑÏãú"ÏôÄ "MainList" Î∂ÄÎ∂ÑÏóê Î∞∞Í≤ΩÏÉâ ÏÑ§Ï†ï
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Padding(
                      padding: const EdgeInsets.all(13.0),
                      child: Text('Ïò§ÎäòÏùò Ï†ÑÏãúüå§Ô∏è', style: TextStyle(fontSize: 18,color: Color(0xffD4D8C8),fontWeight: FontWeight.bold)),
                    ),
                    Center(
                      child: Container(
                        child: MainList(), // MainListÏóê Ï†ÑÏãú Ï†ïÎ≥¥ Ï†ÑÎã¨
                        height: 400,
                      ),
                    ),
                  ],
                ),
              ),
              Padding(
                padding: const EdgeInsets.all(13.0),
                child: Text('ÏßÄÍ∏à Ïù∏Í∏∞ÏûàÎäî Ï†ÑÏãúüî•', style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold)),
              ),
              Container(
                child: popularEx(), // ImageListÏóê Ï†ÑÏãú Ï†ïÎ≥¥ Ï†ÑÎã¨
                height: 260,
              ),
              Padding(
                padding: const EdgeInsets.only(left: 13.0),
                child: Text('ÏöîÏ¶ò ÎßéÏù¥ Ï∞æÎäî ÏßÄÏó≠üîé', style: TextStyle(fontSize:18,fontWeight: FontWeight.bold)),
              ),
              Padding(
                padding: const EdgeInsets.only(left: 13.0, top: 5),
                child: Text('ÏµúÏã† Í≥µÍ∞Ñ ÏÜåÏãùÏùÑ Î∞õÏïÑÏÑ∏Ïöîüîî',
                  style: TextStyle(fontSize: 10, color: Colors.grey, fontWeight: FontWeight.bold),
                ),
              ),
              Container(
                child: UserList(),
                height: 110,
              ),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Padding(
                    padding: const EdgeInsets.all(13.0),
                    child: Text('Ïñ¥Îñ§ Ï†ÑÏãúÌöåÍ∞Ä Ï¢ãÏùÑÏßÄ Í≥†ÎØºÎêúÎã§Î©¥?ü§î', style: TextStyle(fontSize:18,fontWeight: FontWeight.bold)),
                  ),
                  TextButton(
                    onPressed: () {
                      Navigator.push(context, MaterialPageRoute(builder: (context) => AddView()));
                    },
                    child: Text(
                      'ÎçîÎ≥¥Í∏∞',
                      style: TextStyle(color: Colors.grey, fontWeight: FontWeight.bold),
                    ),
                  ),
                ],
              ),
              Container(
                child: recommendEx(), // ImageListÏóê Ï†ÑÏãú Ï†ïÎ≥¥ Ï†ÑÎã¨
                height: 300,
              ),
              Padding(
                padding: const EdgeInsets.all(13.0),
                child: Text('Í≥ß Ï¢ÖÎ£åÎêòÎäî Ï†ÑÏãúüï∞Ô∏è', style: TextStyle(fontSize:18,fontWeight: FontWeight.bold)),
              ),
              Container(child: endExList(),height: 260,), // ImageListÏóê Ï†ÑÏãú Ï†ïÎ≥¥ Ï†ÑÎã¨
            ],
          ),
        );
      },
    );
  }
}
///ÏßÄÍ∏à Ïù∏Í∏∞ÏûàÎäî Ï†ÑÏãú!
class popularEx extends StatefulWidget {
  @override
  State<popularEx> createState() => _popularExState();
}

class _popularExState extends State<popularEx> {
  final PageController _pageController = PageController(viewportFraction: 0.85);
  int currentPage = 0;
  Stream<QuerySnapshot> _snapshot = FirebaseFirestore.instance
      .collection('exhibition')
      .orderBy('postDate', descending: true)
      .snapshots();

  @override
  void initState() {
    super.initState();
    startAutoSlide();
  }

  void startAutoSlide() {
    Future.delayed(Duration(seconds: 4), () async{
      var snapshot = await FirebaseFirestore.instance
          .collection('exhibition')
          .orderBy('postDate', descending: true)
          .get();
      if (snapshot.docs.isNotEmpty) {
        if (currentPage < (snapshot.docs.length / 3).ceil() - 1) {
          currentPage++;
        } else {
          currentPage = 0;
        }
        _pageController.animateToPage(
          currentPage,
          duration: Duration(milliseconds: 500),
          curve: Curves.easeOut,
        );
        startAutoSlide();
      }
    });
  }


  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<QuerySnapshot>(
      stream: _snapshot,
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(child: CircularProgressIndicator());
        }
        if (snapshot.hasError) {
          return Center(child: Text('ÏóêÎü¨ Î∞úÏÉù: ${snapshot.error}'));
        }
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(child: Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'));
        }
        return Container(
          constraints: BoxConstraints(maxHeight: 400),
          child: PageView.builder(
            controller: _pageController,
            itemCount: (snapshot.data!.docs.length / 3).ceil(),
            itemBuilder: (context, pageIndex) {
              final start = pageIndex * 3;
              final end = (start + 1).clamp(0, snapshot.data!.docs.length - 1);

              return Row(
                children: List.generate(end - start + 1, (index) {
                  final doc = snapshot.data!.docs[start + index];
                  final data = doc.data() as Map<String, dynamic>;

                  String imageURL = '';

                  return FutureBuilder<QuerySnapshot>(
                    future: FirebaseFirestore.instance
                        .collection('exhibition')
                        .doc(doc.id)
                        .collection('exhibition_image')
                        .get(),
                    builder: (context, subSnapshot) {
                      if (subSnapshot.connectionState == ConnectionState.waiting) {
                        return Center(child: CircularProgressIndicator());
                      }
                      if (subSnapshot.hasData) {
                        QuerySnapshot subQuerySnapshot = subSnapshot.data!;
                        List<Map<String, dynamic>> images = subQuerySnapshot.docs.map((subDoc) {
                          return {
                            'imageURL': (subDoc.data() as Map<String, dynamic>)['imageURL'] as String,
                          };
                        }).toList();

                        if (images.isNotEmpty) {
                          imageURL = images[0]['imageURL'];
                        }
                      }
                      final galleryNo = data['galleryNo'] as String;
                      return StreamBuilder<DocumentSnapshot>(
                        stream: FirebaseFirestore.instance.collection('gallery').doc(galleryNo).snapshots(),
                        builder: (context, gallerySnapshot) {
                          if (gallerySnapshot.connectionState == ConnectionState.waiting) {
                            return Center(child: CircularProgressIndicator());
                          }
                          if (gallerySnapshot.hasData && gallerySnapshot.data!.exists) {
                            final galleryName = gallerySnapshot.data!['galleryName'] as String;
                            final galleryRegion = gallerySnapshot.data!['region'] as String;

                            return InkWell(
                              onTap: () {
                                print('exTitle: ${data['exTitle']}');
                                print('imageURL: $imageURL');
                                print('galleryName: $galleryName');
                                print('galleryRegion: $galleryRegion');
                              },
                              child: Padding(
                                padding: const EdgeInsets.only(left: 15.0),
                                child: Container(
                                  width: 150,
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Image.network(
                                        imageURL,
                                        width: 150,
                                        height: 150,
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 4.0),
                                        child: Text(data['exTitle'], style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 4.0),
                                        child: Text('$galleryName/$galleryRegion', style: TextStyle(
                                          fontSize: 10,
                                          color: Colors.grey,
                                          fontWeight: FontWeight.bold,
                                        )),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 6.0),
                                        child: Text('${formatFirestoreDate(data['startDate'])} ~ ${formatFirestoreDate(data['endDate'])}', style: TextStyle(
                                          fontSize: 10,
                                          color: Colors.grey,
                                          fontWeight: FontWeight.bold,
                                        )),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            );
                          } else {
                            return Text('Í∞§Îü¨Î¶¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                          }
                        },
                      );
                    },
                  );
                }),
              );
            },
          ),
        );
      },
    );
  }

  String formatFirestoreDate(Timestamp timestamp) {
    DateTime date = timestamp.toDate();
    final formatter = DateFormat('yyyy-MM-dd');
    return formatter.format(date);
  }
}

/// Î©îÏù∏ ÏµúÏÉÅÎã®
class MainList extends StatefulWidget {
  final List<Map<String, String>> images = [
    {
      'name': 'Ï†ÑÏãú1.png',
      'title': 'Ïã†Ï≤†_ÎãπÏã†ÏùÑ Í∑∏Î¶ΩÎãàÎã§',
      'description': '608Í∞§Îü¨Î¶¨/Í≤ΩÍ∏∞',
    },
    {
      'name': 'Ï†ÑÏãú2.jpg',
      'title': 'Íµ¨Ï†ïÏïÑ : Í≥µÏ§ëÎ∂ÄÏñë',
      'description': 'PKMÍ∞§Îü¨Î¶¨/ÏÑúÏö∏',
    },
    {
      'name': 'ÎïåÍπî3.jpg',
      'title': 'ÏïÑÎ¶¨Í∞Ä : ÎòêÎÑ§',
      'description': 'ÌïòÎùºÏ£ºÏø†/ÏùºÎ≥∏',
    },
  ];

  @override
  _MainListState createState() => _MainListState();
}
class _MainListState extends State<MainList> {
  final PageController _controller = PageController(viewportFraction: 0.8);
  int _currentPage = 0;
  String? region;
  String? galleryName;
  @override
  void initState() {
    super.initState();
    _startAutoScroll();
  }

  void _startAutoScroll() {
    Future.delayed(Duration(seconds: 3)).then((_) {
      if (mounted) {
        int nextPage = (_currentPage + 1) % widget.images.length;
        _controller.animateToPage(
          nextPage,
          duration: Duration(milliseconds: 1000),
          curve: Curves.easeOut,
        ).then((_) {
          _currentPage = nextPage;
          _startAutoScroll(); // Ïä¨ÎùºÏù¥ÎìúÍ∞Ä ÏôÑÎ£åÎêú ÌõÑ Îã§Ïùå Ïä¨ÎùºÏù¥Îìú ÏãúÏûë
        });
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder(
      stream: FirebaseFirestore.instance
          .collection('exhibition')
          .orderBy('postDate', descending: true)
          .limit(3)
          .snapshots(),
      builder: (context, AsyncSnapshot<QuerySnapshot> snap) {
        if (snap.connectionState == ConnectionState.waiting) {
          return Center(child: CircularProgressIndicator());
        }
        if (snap.hasError) {
          return Center(child: Text('ÏóêÎü¨ Î∞úÏÉù: ${snap.error}'));
        }
        if (!snap.hasData) {
          return Center(child: Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'));
        }
        return Container(
          constraints: BoxConstraints(maxHeight: 400),
          child: PageView.builder(
            controller: _controller,
            itemCount: snap.data!.docs.length,
            itemBuilder: (context, index) {
              DocumentSnapshot doc = snap.data!.docs[index];
              Map<String, dynamic> data = doc.data() as Map<String, dynamic>;
              final imageInfo = widget.images[index];

              // 'exhibition_image' ÏÑúÎ∏åÏª¨Î†âÏÖòÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Í∏∞
              String imageURL = '';

              return FutureBuilder(
                future: FirebaseFirestore.instance
                    .collection('exhibition')
                    .doc(doc.id)
                    .collection('exhibition_image')
                    .get(),
                builder: (context, subSnapshot) {
                  if (subSnapshot.connectionState == ConnectionState.waiting) {
                    return Center(child: CircularProgressIndicator());
                  }
                  if (subSnapshot.hasData) {
                    // ÏÑúÎ∏åÏª¨Î†âÏÖòÏùò Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§.
                    QuerySnapshot subQuerySnapshot = subSnapshot.data as QuerySnapshot;
                    List<Map<String, dynamic>> images = subQuerySnapshot.docs.map((subDoc) {
                      return {
                        'imageURL': (subDoc.data() as Map<String, dynamic>)['imageURL'] as String,
                        // Îã§Î•∏ ÏÑúÎ∏åÏª¨Î†âÏÖò ÌïÑÎìúÎèÑ Ï∂îÍ∞Ä
                      };
                    }).toList();
                    // images Î™©Î°ùÏóêÏÑú Ïù¥ÎØ∏ÏßÄ URLÏùÑ Í∞ÄÏ†∏ÏôÄ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.
                    if (images.isNotEmpty) {
                      imageURL = images[0]['imageURL']; // Ïó¨Í∏∞ÏÑúÎäî Ï≤´ Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄÎ•º Í∞ÄÏ†∏Ïò¥
                    }
                  }
                  final galleryNo = doc['galleryNo'] as String;
                  return StreamBuilder<DocumentSnapshot>(
                    stream: FirebaseFirestore.instance
                        .collection('gallery')
                        .doc(galleryNo)
                        .snapshots(),
                    builder: (context, gallerySnapshot) {
                      if (gallerySnapshot.connectionState == ConnectionState.waiting) {
                        return CircularProgressIndicator();
                      }
                      if (gallerySnapshot.hasData && gallerySnapshot.data!.exists) {
                      /// Í∞§Îü¨Î¶¨ Ï†ïÎ≥¥ Í∞ØÎòêÎã§Ï†ú
                        final galleryName = gallerySnapshot.data!['galleryName'] as String;
                        final galleryRegion = gallerySnapshot.data!['region'] as String;
                        final place = galleryName; // Í∞§Îü¨Î¶¨ Ïù¥Î¶ÑÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú place Î≥ÄÏàòÏóê Ìï†Îãπ
                        
                        return InkWell(
                          onTap: () {
                            _onImageClicked(data);
                          },
                          child: Row(
                            children: [
                              Expanded(
                                child: Padding(
                                  padding: EdgeInsets.all(8.0),
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Image.network(
                                        imageURL,
                                        width: MediaQuery.of(context).size.width * 0.5,
                                        height: 310,
                                      ),
                                      Text(
                                        '${data['exTitle']}',
                                        style: TextStyle(
                                          color: Color(0xffD4D8C8),
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 4.0),
                                        child: Text(
                                          '${galleryName}/${galleryRegion}',
                                          style: TextStyle(
                                            fontSize: 10,
                                            color: Colors.grey,
                                            fontWeight: FontWeight.bold,
                                          ),
                                        ),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 6.0),
                                        child: Text('${formatFirestoreDate(data['startDate'])} ~ ${formatFirestoreDate(data['endDate'])}', style: TextStyle(
                                          fontSize: 10,
                                          color: Colors.grey,
                                          fontWeight: FontWeight.bold,
                                        )),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            ],
                          ),
                        );
                      } else {
                        return CircularProgressIndicator();
                      }
                    },
                  );
                },
              );
            },
          ),
        );
      },
    );
  }

  void _onImageClicked(Map<String, dynamic> exhibitionData) {
    // Implement the action to be taken when an image is clicked
    print('Image clicked: ${exhibitionData['exTitle']}');
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  String formatFirestoreDate(Timestamp timestamp) {
    DateTime date = timestamp.toDate();
    final formatter = DateFormat('yyyy-MM-dd');
    return formatter.format(date);
  }
}
/// ÏßÄÏó≠Ï∂îÏ≤ú Î¶¨Ïä§Ìä∏!!
class UserList extends StatefulWidget {

  @override
  _UserListState createState() => _UserListState();
}

class _UserListState extends State<UserList> {

  @override
  void initState() {
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder(
      stream: FirebaseFirestore.instance
          .collection('gallery')
          .snapshots(),
      builder: (context, AsyncSnapshot<QuerySnapshot> snap) {
        if (snap.connectionState == ConnectionState.waiting) {
          return Center(child: CircularProgressIndicator());
        }
        if (snap.hasError) {
          return Center(child: Text('ÏóêÎü¨ Î∞úÏÉù: ${snap.error}'));
        }
        if (!snap.hasData) {
          return Center(child: Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'));
        }

        // Ï§ëÎ≥µÎêòÏßÄ ÏïäÏùÄ Í∞§Îü¨Î¶¨ ÏßÄÏó≠Î™ÖÏùÑ Ï†ÄÏû•Ìï† ÏßëÌï©(Set)ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.
        Set<String> uniqueRegions = Set<String>();

        // Í∞§Îü¨Î¶¨ Î¨∏ÏÑúÎ•º ÏàúÌöåÌïòÎ©¥ÏÑú Ï§ëÎ≥µÎêòÏßÄ ÏïäÏùÄ ÏßÄÏó≠Î™ÖÏùÑ Ï∞æÏäµÎãàÎã§.
        snap.data!.docs.forEach((doc) {
          String galleryRegion = doc['region'] as String;
          uniqueRegions.add(galleryRegion);
        });

        // Í≥†Ïú†Ìïú ÏßÄÏó≠Î™ÖÏùÑ 6Í∞úÍπåÏßÄ ÌëúÏãúÌï©ÎãàÎã§.
        List<String> uniqueRegionsList = uniqueRegions.toList().take(6).toList();

        return Container(
          height: 300,
          child: ListView(
            scrollDirection: Axis.horizontal,
            children: uniqueRegionsList.map((galleryRegion) {
              return StreamBuilder(
                  stream: FirebaseFirestore.instance
                      .collection('gallery')
                      .where('region', isEqualTo: galleryRegion)  // ÏßÄÏó≠Î™ÖÍ≥º ÏùºÏπòÌïòÎäî Í∞§Îü¨Î¶¨Î•º ÏøºÎ¶¨Ìï©ÎãàÎã§.
                      .snapshots(),
                  builder: (context, snapshot) {
                    if (snapshot.connectionState == ConnectionState.waiting) {
                      return CircularProgressIndicator();
                    }
                    if (snapshot.hasError) {
                      return Text('ÏóêÎü¨ Î∞úÏÉù: ${snapshot.error}');
                    }
                    if (!snapshot.hasData) {
                      return Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                    }

                    // Í∞§Îü¨Î¶¨ Î¨∏ÏÑúÍ∞Ä Ïó¨Îü¨ Í∞úÏù∏ Í≤ΩÏö∞, Ïó¨Îü¨ Í∞úÏùò Î¨∏ÏÑúÍ∞Ä Î∞òÌôòÎê©ÎãàÎã§.
                    // Ï≤´ Î≤àÏß∏ Î¨∏ÏÑúÎßå ÏÇ¨Ïö©Ìï† Í≤ÉÏûÖÎãàÎã§. (snapshot.data.docs[0])
                    if (snapshot.data!.docs.isEmpty) {
                      return Text('Ìï¥Îãπ ÏßÄÏó≠Ïùò Í∞§Îü¨Î¶¨ ÏóÜÏùå');
                    }
                    DocumentSnapshot galleryDoc = snapshot.data!.docs[0];

                    // ÏÑúÎ∏åÏª¨Î†âÏÖò 'gallery_image'ÏóêÏÑú Ïù¥ÎØ∏ÏßÄ URL ÌïÑÎìúÎ•º Í∞ÄÏ†∏ÏòµÎãàÎã§.
                    return StreamBuilder(
                      stream: FirebaseFirestore.instance
                          .collection('gallery')
                          .doc(galleryDoc.id)
                          .collection('gallery_image')
                          .snapshots(),
                      builder: (context, galleryImageSnapshot) {
                        if (galleryImageSnapshot.connectionState == ConnectionState.waiting) {
                          return CircularProgressIndicator();
                        }
                        if (galleryImageSnapshot.hasError) {
                          return Text('ÏóêÎü¨ Î∞úÏÉù: ${galleryImageSnapshot.error}');
                        }
                        if (!galleryImageSnapshot.hasData) {
                          return Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                        }

                        // imageURL Í∞ÄÏ†∏Ïò§Í∏∞
                        String imageURL = galleryImageSnapshot.data!.docs[0]['imageURL'] as String;

                        return InkWell(
                          onTap: () {
                            _onUserClicked(galleryRegion);
                            print('ÏßÄÏó≠ Ïù¥ÎØ∏ÏßÄ URL ==> ${imageURL}');
                          },
                          child: Padding(
                            padding: EdgeInsets.all(8.0),
                            child: Column(

                              crossAxisAlignment: CrossAxisAlignment.center,
                              children: [
                                CircleAvatar(
                                  radius: 30,
                                  backgroundImage: Image.network(imageURL).image,
                                ),
                                Text(
                                  galleryRegion,
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 12,
                                  ),
                                ),

                              ],
                            ),
                          ),
                        );
                      },
                    );
                  }
              );
            }).toList(),
          ),
        );

      },
    );
  }

  void _onUserClicked(String galleryRegion) {
    // ÌÅ¥Î¶≠Îêú ÏßÄÏó≠Î™ÖÏùÑ Ï∂úÎ†•Ìï©ÎãàÎã§.
    print('User clicked in region: $galleryRegion');
  }
}
/// Í≥ß Ï¢ÖÎ£åÎêòÎäî Ï†ÑÏãú Î¶¨Ïä§Ìä∏ !!
class endExList extends StatefulWidget {
  @override
  State<endExList> createState() => _endExListState();
}

class _endExListState extends State<endExList> {
  final PageController _pageController = PageController(viewportFraction: 0.85);
  int currentPage = 0;
  Stream<QuerySnapshot> _snapshot = FirebaseFirestore.instance
      .collection('exhibition')
      .orderBy('endDate', descending: true)
      .snapshots();

  @override
  void initState() {
    super.initState();
    startAutoSlide();
  }

  void startAutoSlide() {
    Future.delayed(Duration(seconds: 4), () async{
      var snapshot = await FirebaseFirestore.instance
          .collection('exhibition')
          .orderBy('endDate', descending: true)
          .get();
      if (snapshot.docs.isNotEmpty) {
        if (currentPage < (snapshot.docs.length / 3).ceil() - 1) {
          currentPage++;
        } else {
          currentPage = 0;
        }
        _pageController.animateToPage(
          currentPage,
          duration: Duration(milliseconds: 500),
          curve: Curves.easeOut,
        );
        startAutoSlide();
      }
    });
  }


  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<QuerySnapshot>(
      stream: _snapshot,
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(child: CircularProgressIndicator());
        }
        if (snapshot.hasError) {
          return Center(child: Text('ÏóêÎü¨ Î∞úÏÉù: ${snapshot.error}'));
        }
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(child: Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'));
        }
        return Container(
          constraints: BoxConstraints(maxHeight: 400),
          child: PageView.builder(
            controller: _pageController,
            itemCount: (snapshot.data!.docs.length / 3).ceil(),
            itemBuilder: (context, pageIndex) {
              final start = pageIndex * 3;
              final end = (start + 1).clamp(0, snapshot.data!.docs.length - 1);

              return Row(
                children: List.generate(end - start + 1, (index) {
                  final doc = snapshot.data!.docs[start + index];
                  final data = doc.data() as Map<String, dynamic>;

                  String imageURL = '';

                  return FutureBuilder<QuerySnapshot>(
                    future: FirebaseFirestore.instance
                        .collection('exhibition')
                        .doc(doc.id)
                        .collection('exhibition_image')
                        .get(),
                    builder: (context, subSnapshot) {
                      if (subSnapshot.connectionState == ConnectionState.waiting) {
                        return Center(child: CircularProgressIndicator());
                      }
                      if (subSnapshot.hasData) {
                        QuerySnapshot subQuerySnapshot = subSnapshot.data!;
                        List<Map<String, dynamic>> images = subQuerySnapshot.docs.map((subDoc) {
                          return {
                            'imageURL': (subDoc.data() as Map<String, dynamic>)['imageURL'] as String,
                          };
                        }).toList();

                        if (images.isNotEmpty) {
                          imageURL = images[0]['imageURL'];
                        }
                      }
                      final galleryNo = data['galleryNo'] as String;
                      return StreamBuilder<DocumentSnapshot>(
                        stream: FirebaseFirestore.instance.collection('gallery').doc(galleryNo).snapshots(),
                        builder: (context, gallerySnapshot) {
                          if (gallerySnapshot.connectionState == ConnectionState.waiting) {
                            return Center(child: CircularProgressIndicator());
                          }
                          if (gallerySnapshot.hasData && gallerySnapshot.data!.exists) {
                            final galleryName = gallerySnapshot.data!['galleryName'] as String;
                            final galleryRegion = gallerySnapshot.data!['region'] as String;

                            return InkWell(
                              onTap: () {
                                print('exTitle: ${data['exTitle']}');
                                print('imageURL: $imageURL');
                                print('galleryName: $galleryName');
                                print('galleryRegion: $galleryRegion');
                              },
                              child: Padding(
                                padding: const EdgeInsets.only(left: 15.0),
                                child: Container(
                                  width: 150,
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Image.network(
                                        imageURL,
                                        width: 150,
                                        height: 150,
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 6.0),
                                        child: Text(data['exTitle'], style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 4.0),
                                        child: Text('$galleryName/$galleryRegion', style: TextStyle(
                                          fontSize: 10,
                                          color: Colors.grey,
                                          fontWeight: FontWeight.bold,
                                        )),
                                      ),
                                      Padding(
                                        padding: const EdgeInsets.only(top: 5.0),
                                        child: Text('${formatFirestoreDate(data['startDate'])} ~ ${formatFirestoreDate(data['endDate'])}', style: TextStyle(
                                          fontSize: 10,
                                          color: Colors.grey,
                                          fontWeight: FontWeight.bold,
                                        )),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            );
                          } else {
                            return Text('Í∞§Îü¨Î¶¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                          }
                        },
                      );
                    },
                  );
                }),
              );
            },
          ),
        );
      },
    );
  }
  String formatFirestoreDate(Timestamp timestamp) {
    DateTime date = timestamp.toDate();
    final formatter = DateFormat('yyyy-MM-dd');
    return formatter.format(date);
  }
}

/// Ï∂îÏ≤ú Ï†ÑÏãú Î¶¨Ïä§Ìä∏ !!
class recommendEx extends StatefulWidget {
  recommendEx({super.key});

  @override
  State<recommendEx> createState() => _recommendExState();
}

class _recommendExState extends State<recommendEx> {
  Stream<QuerySnapshot> _snapshot = FirebaseFirestore.instance
      .collection('exhibition')
      .orderBy('endDate', descending: true)
      .snapshots();

  @override
  Widget build(BuildContext context) {
    return StreamBuilder(
      stream: _snapshot,
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return Center(child: CircularProgressIndicator());
        }
        if (snapshot.hasError) {
          return Center(child: Text('ÏóêÎü¨ Î∞úÏÉù: ${snapshot.error}'));
        }
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Center(child: Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'));
        }

        return Column(
          children: [
            _buildExhibitionWidget(snapshot, 1),
            _buildExhibitionWidget(snapshot, 2),
            _buildExhibitionWidget(snapshot, 3),
          ],
        );
      },
    );
  }
  Widget _buildExhibitionWidget(AsyncSnapshot<QuerySnapshot> snapshot, int index) {
    if(index >= snapshot.data!.docs.length){
      return Container();
    }

        final doc = snapshot.data!.docs[index];
        final data = doc.data() as Map<String, dynamic>;
        String imageURL = '';

        return Container(
          child: FutureBuilder<QuerySnapshot>(
            future: FirebaseFirestore.instance
                .collection('exhibition')
                .doc(doc.id)
                .collection('exhibition_image')
                .get(),
            builder: (context, subSnapshot) {
              if (subSnapshot.connectionState == ConnectionState.waiting) {
                return Center(child: CircularProgressIndicator());
              }
              if (subSnapshot.hasData) {
                QuerySnapshot subQuerySnapshot = subSnapshot.data!;
                List<Map<String, dynamic>> images = subQuerySnapshot.docs.map((subDoc) {
                  return {
                    'imageURL': (subDoc.data() as Map<String, dynamic>)['imageURL'] as String,
                  };
                }).toList();
                if (images.isNotEmpty) {
                  imageURL = images[0]['imageURL'];
                }
              }
              final galleryNo = data['galleryNo'] as String;
              return StreamBuilder<DocumentSnapshot>(
                stream: FirebaseFirestore.instance.collection('gallery').doc(galleryNo).snapshots(),
                builder: (context, gallerySnapshot) {
                  if (gallerySnapshot.connectionState == ConnectionState.waiting) {
                    return Center(child: CircularProgressIndicator());
                  }
                  if (gallerySnapshot.data != null && gallerySnapshot.data!.exists) {
                    final galleryName = gallerySnapshot.data!['galleryName'] as String;
                    final galleryRegion = gallerySnapshot.data!['region'] as String;

                    return InkWell(
                      onTap: () {
                        print('exTitle: ${data['exTitle']}');
                        print('imageURL: $imageURL');
                        print('galleryName: $galleryName');
                        print('galleryRegion: $galleryRegion');
                      },
                      child: Container(
                        child: Wrap(
                          alignment: WrapAlignment.start,
                          children: [
                            Row(
                              mainAxisAlignment: MainAxisAlignment.center, // Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖçÏä§Ìä∏Î•º ÏàòÌèâÏúºÎ°ú Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨
                              children: [
                                Image.network(
                                  imageURL,
                                  width: 150,
                                  height: 100,
                                ),
                                Column(
                                  crossAxisAlignment: CrossAxisAlignment.start, // ÌÖçÏä§Ìä∏Î•º ÏàòÏßÅÏúºÎ°ú Í∞ÄÏö¥Îç∞Î°ú Ï†ïÎ†¨
                                  children: [
                                    Text(data['exTitle'], style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                                    Padding(
                                      padding: const EdgeInsets.only(top: 4.0),
                                      child: Text('$galleryName/$galleryRegion', style: TextStyle(
                                        fontSize: 10,
                                        color: Colors.grey,
                                        fontWeight: FontWeight.bold,
                                      )),
                                    ),
                                    Padding(
                                      padding: const EdgeInsets.only(top: 8.0),
                                      child: Text('${formatFirestoreDate(data['startDate'])} ~ ${formatFirestoreDate(data['endDate'])}', style: TextStyle(
                                        fontSize: 10,
                                        color: Colors.grey,
                                        fontWeight: FontWeight.bold,
                                      )),
                                    ),
                                  ],
                                ),
                                Spacer(), // ÏôºÏ™Ω Í≥µÍ∞ÑÏùÑ Ï±ÑÏö∞Îäî Spacer ÏúÑÏ†Ø
                              ],
                            ),
                          ],
                        ),
                      ),
                    );

                  } else {
                    return Text('Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                  }
                },
              );
            },
          ),
        );
      }
  String formatFirestoreDate(Timestamp timestamp) {
    DateTime date = timestamp.toDate();
    final formatter = DateFormat('yyyy-MM-dd');
    return formatter.format(date);
  }
}
